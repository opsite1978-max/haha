<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æŒ‡æ±ºç­–æ ¸å¿ƒ V14.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --input-bg: #334155; --text: #f1f5f9; --red: #ef4444; --green: #10b981; --gold: #f59e0b; --blue: #3b82f6; --purple: #a855f7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 120px; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card); border-radius: 16px; border: 1px solid #475569; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .header { background: linear-gradient(to right, #0f172a, #1e293b); padding: 15px; text-align: center; border-bottom: 1px solid #334155; }
        h1 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 1px; color: #fff; }
        .subtitle { font-size: 11px; color: #94a3b8; margin-top: 5px; }

        .portal-bar { display: flex; gap: 8px; padding: 12px 15px; background: #0b1120; overflow-x: auto; border-bottom: 1px solid #333; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .portal-btn { flex: 0 0 auto; padding: 6px 12px; border-radius: 20px; font-size: 11px; text-decoration: none; color: #cbd5e1; border: 1px solid #475569; transition: 0.2s; display: flex; align-items: center; gap: 4px; background: #1e293b; }
        .portal-btn:hover { background: #334155; border-color: #94a3b8; color: #fff; }
        .portal-icon { font-size: 12px; }

        .btn-group { padding: 10px 15px; display: flex; gap: 8px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; font-size: 13px; }
        .btn-auto { background: var(--blue); }
        .btn-record { background: var(--green); }
        .btn-clear { background: #475569; max-width: 60px; }

        .chart-container { position: relative; height: 180px; width: 100%; padding: 10px; box-sizing: border-box; background: #0b1120; }

        .section { padding: 0 15px 10px 15px; }
        .section-title { font-size: 12px; color: #94a3b8; font-weight: 700; margin-bottom: 8px; border-left: 3px solid var(--blue); padding-left: 6px; margin-top: 10px; display: flex; justify-content: space-between; }
        
        .row { display: flex; gap: 8px; margin-bottom: 8px; }
        .col { flex: 1; }
        label { display: block; font-size: 10px; color: #cbd5e1; margin-bottom: 3px; }
        input { width: 100%; background: var(--input-bg); border: 1px solid #475569; color: white; padding: 10px; border-radius: 6px; font-size: 16px; font-weight: 600; text-align: center; outline: none; }
        input:focus { border-color: var(--blue); background: #1e293b; }

        .hl-input input { border-color: var(--gold); background: #422006; color: #fbbf24; } 
        .total-input input { border-color: var(--purple); background: #3b0764; color: #d8b4fe; font-size: 18px; }
        .retail-group { border: 1px dashed #475569; padding: 8px; border-radius: 8px; margin-bottom: 8px; }

        /* é—œéµé»ä½é¡¯ç¤ºå€ */
        .key-levels-box { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; background: #0f172a; padding: 10px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 10px; }
        .level-item { text-align: center; padding: 5px; background: #1e293b; border-radius: 4px; }
        .level-title { font-size: 10px; color: #94a3b8; }
        .level-val { font-size: 14px; font-weight: bold; color: #fff; }
        .level-up { color: #ef4444; } .level-mid { color: #f59e0b; } .level-down { color: #10b981; }

        .verdict-box { background: #020617; padding: 15px; text-align: center; border-top: 1px solid #333; }
        .verdict { font-size: 24px; font-weight: 900; margin-bottom: 5px; }
        .desc { font-size: 12px; color: #94a3b8; }
        .history-log { max-height: 80px; overflow-y: auto; font-size: 10px; color: #666; padding: 10px; border-top: 1px solid #333; }
        
        #loading { display: none; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸš€ å°æŒ‡æ±ºç­–æ ¸å¿ƒ V14.0</h1>
        <div class="subtitle">ç©è‚¡ç¶²æˆ°æƒ… â€¢ ä¸‰é—œåƒ¹ â€¢ è½‰æŠ˜é—œéµé»</div>
    </div>

    <div class="portal-bar">
        <a href="https://www.wantgoo.com/futures/institutional/net-open-interest" target="_blank" class="portal-btn">
            <span class="portal-icon">ğŸ”—</span> ç©è‚¡ä¸»åŠ›
        </a>
        <a href="https://www.wantgoo.com/option/put-call-ratio" target="_blank" class="portal-btn">
            <span class="portal-icon">ğŸ”—</span> P/C Ratio
        </a>
        <a href="https://www.wantgoo.com/futures/retail-indicator/wmt&" target="_blank" class="portal-btn">
            <span class="portal-icon">ğŸ”—</span> æ•£æˆ¶æŒ‡æ¨™
        </a>
    </div>

    <div class="chart-container">
        <canvas id="trendChart"></canvas>
    </div>

    <div class="btn-group">
        <button class="btn btn-auto" onclick="autoFetch()">
            âš¡ æŠ“å–æ˜¨æ”¶/æ³¢å‹• <span id="loading">â†»</span>
        </button>
        <button class="btn btn-record" onclick="recordData()">
            ğŸ’¾ è¨˜éŒ„
        </button>
        <button class="btn btn-clear" onclick="clearHistory()">ğŸ—‘ï¸</button>
    </div>

    <div class="section">
        <div class="section-title">ğŸ”‘ ä»Šæ—¥é—œéµé»ä½ (ä¾æ˜¨æ”¶è¨ˆç®—)</div>
        <div class="key-levels-box">
            <div class="level-item"><div class="level-title">ä¸Šé—œ (å£“)</div><div id="kp_high" class="level-val level-up">--</div></div>
            <div class="level-item"><div class="level-title">ä¸­é—œ (åˆ†)</div><div id="kp_mid" class="level-val level-mid">--</div></div>
            <div class="level-item"><div class="level-title">ä¸‹é—œ (æ’)</div><div id="kp_low" class="level-val level-down">--</div></div>
            <div class="level-item"><div class="level-title">è½‰æŠ˜å£“</div><div id="pivot_res" class="level-val level-up">--</div></div>
            <div class="level-item"><div class="level-title">è½‰æŠ˜åƒ¹</div><div id="pivot_p" class="level-val level-mid">--</div></div>
            <div class="level-item"><div class="level-title">è½‰æŠ˜æ’</div><div id="pivot_sup" class="level-val level-down">--</div></div>
        </div>
        <div style="display:none;">
            <input id="prev_high"><input id="prev_low"><input id="prev_close">
        </div>
    </div>

    <div class="section">
        <div class="section-title">1. åƒ¹æ ¼èˆ‡ P/C</div>
        <div class="row">
            <div class="col hl-input">
                <label>ğŸ“ å°æŒ‡æœŸ (ç›®å‰)</label>
                <input type="number" id="tx" placeholder="è¼¸å…¥..." oninput="calc()">
            </div>
            <div class="col">
                <label>ğŸ›¡ï¸ P/C Ratio (%)</label>
                <input type="number" id="pc" placeholder="æ‰‹å‹•è¼¸å…¥" oninput="calc()">
            </div>
            <div class="col">
                <label>ATR æ³¢å‹•</label>
                <input type="number" id="atr" oninput="calc()">
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">2. ä¸»åŠ›ç±Œç¢¼ (çœ‹ç©è‚¡ç¶²å¡«ç¸½å’Œ)</div>
        <div class="row">
            <div class="col total-input">
                <label>ğŸ¦ æ³•äººç¸½å’Œ (è‡ª+æŠ•+å¤–)</label>
                <input type="number" id="total_sum" placeholder="çœ‹ç©è‚¡ç¶²ã€Œç¸½å’Œã€æ¬„ä½" oninput="calc()">
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">3. æ•£æˆ¶ (è¼¸å…¥çœ‹ç›¤è»Ÿé«”æ•¸å€¼)</div>
        <div class="retail-group">
            <div class="row">
                <div class="col">
                    <label style="color:#fca5a5;">å°å°å¤šå–®</label>
                    <input type="number" id="mtx_long" placeholder="é‡" style="color:#fca5a5; border-color:#991b1b;" oninput="calc()">
                </div>
                <div class="col">
                    <label style="color:#86efac;">å°å°ç©ºå–®</label>
                    <input type="number" id="mtx_short" placeholder="é‡" style="color:#86efac; border-color:#065f46;" oninput="calc()">
                </div>
            </div>
        </div>
        <div class="retail-group">
            <div class="row">
                <div class="col">
                    <label style="color:#fca5a5;">å¾®å°å¤šå–®</label>
                    <input type="number" id="tmf_long" placeholder="é‡" style="color:#fca5a5; border-color:#991b1b;" oninput="calc()">
                </div>
                <div class="col">
                    <label style="color:#86efac;">å¾®å°ç©ºå–®</label>
                    <input type="number" id="tmf_short" placeholder="é‡" style="color:#86efac; border-color:#065f46;" oninput="calc()">
                </div>
            </div>
        </div>
    </div>

    <div class="verdict-box">
        <div id="verdict" class="verdict" style="color:#64748b">ç­‰å¾…æ•¸æ“š</div>
        <div id="desc" class="desc">å¡«å¯«å¾Œè‡ªå‹•åˆ†æå¤šç©º</div>
        
        <div style="display:flex; justify-content:space-around; margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
            <div>
                <div style="font-size:10px; color:#888;">ä¿å®ˆç›®æ¨™</div>
                <div id="tp1" style="font-size:16px; font-weight:bold; color:#ccc;">--</div>
            </div>
            <div>
                <div style="font-size:10px; color:#888;">ç©æ¥µç›®æ¨™</div>
                <div id="tp2" style="font-size:16px; font-weight:bold; color:#ccc;">--</div>
            </div>
        </div>
    </div>
    
    <div class="history-log" id="log-display">æ­·å²ç´€éŒ„...</div>
</div>

<script>
    let myChart;
    const ids = ['tx', 'atr', 'total_sum', 'pc', 'mtx_long', 'mtx_short', 'tmf_long', 'tmf_short', 'prev_high', 'prev_low', 'prev_close'];

    window.onload = () => {
        ids.forEach(id => {
            const v = localStorage.getItem('last_' + id);
            if(v) document.getElementById(id).value = v;
        });
        initChart();
        updateChartFromStorage();
        calc();
    };

    function initChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'å°æŒ‡æœŸ', data: [], borderColor: '#3b82f6', yAxisID: 'y', borderWidth: 2, tension: 0.1 },
                    { label: 'P/C %', data: [], borderColor: '#f59e0b', yAxisID: 'y1', borderWidth: 2, borderDash: [5, 5], tension: 0.1 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { labels: { color: '#ccc', boxWidth: 10 } } },
                scales: {
                    x: { ticks: { color: '#666' }, grid: { color: '#222' } },
                    y: { type: 'linear', display: true, position: 'left', ticks: { color: '#3b82f6' }, grid: { color: '#333' } },
                    y1: { type: 'linear', display: true, position: 'right', ticks: { color: '#f59e0b' }, grid: { drawOnChartArea: false } }
                }
            }
        });
    }

    async function autoFetch() {
        const icon = document.getElementById('loading');
        icon.style.display = 'inline-block';
        try {
            const ts = new Date().getTime();
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/%5ETWII?interval=1d&range=5d&_=' + ts)}`);
            const data = await res.json();
            const result = JSON.parse(data.contents).chart.result[0];
            const quotes = result.indicators.quote[0];
            
            const len = quotes.close.length;
            let idx = len - 1;
            if (len >= 2) idx = len - 2;

            const prevH = quotes.high[idx];
            const prevL = quotes.low[idx];
            const prevC = quotes.close[idx];
            const lastPrice = result.meta.regularMarketPrice;

            let sum = 0, count = 0;
            for(let i=0; i<len; i++) {
                if(quotes.high[i]) { sum += (quotes.high[i] - quotes.low[i]); count++; }
            }
            const atr = count ? Math.round(sum/count) : 250;

            document.getElementById('atr').value = atr;
            document.getElementById('prev_high').value = prevH;
            document.getElementById('prev_low').value = prevL;
            document.getElementById('prev_close').value = prevC;

            if(!document.getElementById('tx').value) document.getElementById('tx').value = Math.round(lastPrice);
            
            calc();
        } catch(e) { alert('æŠ“å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); }
        icon.style.display = 'none';
    }

    function calc() {
        ids.forEach(id => {
            const el = document.getElementById(id);
            localStorage.setItem('last_' + id, el.value);
        });

        const tx = parseInt(document.getElementById('tx').value);
        const atr = parseInt(document.getElementById('atr').value) || 250;
        const total = parseInt(document.getElementById('total_sum').value) || 0;
        const pc = parseFloat(document.getElementById('pc').value) || 100;
        
        const mtx_L = parseInt(document.getElementById('mtx_long').value) || 0;
        const mtx_S = parseInt(document.getElementById('mtx_short').value) || 0;
        const tmf_L = parseInt(document.getElementById('tmf_long').value) || 0;
        const tmf_S = parseInt(document.getElementById('tmf_short').value) || 0;
        const retail_net = (mtx_L - mtx_S) + ((tmf_L - tmf_S) * 0.2);

        // --- ä¸‰é—œåƒ¹èˆ‡è½‰æŠ˜åƒ¹è¨ˆç®— ---
        const pH = parseFloat(document.getElementById('prev_high').value);
        const pL = parseFloat(document.getElementById('prev_low').value);
        const pC = parseFloat(document.getElementById('prev_close').value);

        if (pH && pL && pC) {
            const mid = (pH + pL) / 2;
            const up = pL + (pH - pL) * 0.618;
            const down = pH - (pH - pL) * 0.618;

            document.getElementById('kp_high').innerText = Math.round(up);
            document.getElementById('kp_mid').innerText = Math.round(mid);
            document.getElementById('kp_low').innerText = Math.round(down);

            const cdp = (pH + pL + 2*pC) / 4;
            const nh = 2*cdp - pL;      
            const nl = 2*cdp - pH;      
            
            document.getElementById('pivot_p').innerText = Math.round(cdp);
            document.getElementById('pivot_res').innerText = Math.round(nh);
            document.getElementById('pivot_sup').innerText = Math.round(nl);
        }

        if(!tx) return;

        // --- è©•åˆ† ---
        let score = 0;
        if (total > 5000) score += 35;
        else if (total < -5000) score -= 35;

        if(pc > 110) score += 20; else if(pc < 90) score -= 20;
        if(retail_net > 3000) score -= 25; else if(retail_net < -3000) score += 25;

        const vEl = document.getElementById('verdict');
        const dEl = document.getElementById('desc');
        const tp1 = document.getElementById('tp1');
        const tp2 = document.getElementById('tp2');

        if(score >= 20) {
            vEl.innerText = "ğŸš€ åå¤š"; vEl.style.color = "#ef4444";
            dEl.innerText = `ä¸»åŠ› +${total} / æ•£æˆ¶åå‘`;
            tp1.innerText = Math.round(tx + atr); tp1.style.color="#ef4444";
            tp2.innerText = Math.round(tx + atr * 1.618); tp2.style.color="#ef4444";
        } else if(score <= -20) {
            vEl.innerText = "ğŸ“‰ åç©º"; vEl.style.color = "#10b981";
            dEl.innerText = `ä¸»åŠ› ${total} / ç±Œç¢¼é¬†å‹•`;
            tp1.innerText = Math.round(tx - atr); tp1.style.color="#10b981";
            tp2.innerText = Math.round(tx - atr * 1.618); tp2.style.color="#10b981";
        } else {
            vEl.innerText = "âš–ï¸ éœ‡ç›ª"; vEl.style.color = "#94a3b8";
            dEl.innerText = `å¤šç©ºäº’æŠµï¼Œåƒè€ƒä¸‰é—œåƒ¹æ“ä½œ`;
            tp1.innerText = Math.round(tx + atr * 0.5); tp1.style.color="#cbd5e1";
            tp2.innerText = Math.round(tx - atr * 0.5); tp2.style.color="#cbd5e1";
        }
    }

    function recordData() {
        const tx = document.getElementById('tx').value;
        const pc = document.getElementById('pc').value;
        if(!tx || !pc) { alert("è«‹å…ˆè¼¸å…¥æ•¸æ“š"); return; }
        const today = new Date();
        const dateStr = (today.getMonth()+1) + "/" + today.getDate();
        const newData = { date: dateStr, tx: parseFloat(tx), pc: parseFloat(pc) };
        let history = JSON.parse(localStorage.getItem('stock_history') || "[]");
        const existIdx = history.findIndex(d => d.date === dateStr);
        if(existIdx >= 0) history[existIdx] = newData;
        else history.push(newData);
        if(history.length > 14) history = history.slice(-14);
        localStorage.setItem('stock_history', JSON.stringify(history));
        updateChartFromStorage();
    }

    function updateChartFromStorage() {
        const history = JSON.parse(localStorage.getItem('stock_history') || "[]");
        const logEl = document.getElementById('log-display');
        myChart.data.labels = history.map(d => d.date);
        myChart.data.datasets[0].data = history.map(d => d.tx);
        myChart.data.datasets[1].data = history.map(d => d.pc);
        myChart.update();
        logEl.innerHTML = history.length ? history.map(d => `<span>[${d.date}] æŒ‡æ•¸:${d.tx} | P/C:${d.pc}%</span>`).join("<br>") : "å°šç„¡ç´€éŒ„";
    }

    function clearHistory() {
        if(confirm("æ¸…é™¤ç´€éŒ„ï¼Ÿ")) { localStorage.removeItem('stock_history'); updateChartFromStorage(); }
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æŒ‡æ±ºç­–æ ¸å¿ƒ V12.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --input-bg: #334155; --text: #f1f5f9; --red: #ef4444; --green: #10b981; --gold: #f59e0b; --blue: #3b82f6; --purple: #a855f7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 120px; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card); border-radius: 16px; border: 1px solid #475569; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .header { background: linear-gradient(to right, #0f172a, #1e293b); padding: 15px; text-align: center; border-bottom: 1px solid #334155; }
        h1 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 1px; color: #fff; }
        .subtitle { font-size: 11px; color: #94a3b8; margin-top: 5px; }

        .chart-container { position: relative; height: 200px; width: 100%; padding: 10px; box-sizing: border-box; background: #0b1120; }

        /* æ•¸æ“šå‚³é€é–€ */
        .portal-bar { display: flex; gap: 8px; padding: 12px 15px; background: #0b1120; overflow-x: auto; border-bottom: 1px solid #333; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .portal-btn { flex: 0 0 auto; padding: 6px 12px; border-radius: 20px; font-size: 11px; text-decoration: none; color: #cbd5e1; border: 1px solid #475569; transition: 0.2s; display: flex; align-items: center; gap: 4px; background: #1e293b; }
        .portal-btn:hover { background: #334155; border-color: #94a3b8; color: #fff; }

        .btn-group { padding: 10px 15px; display: flex; gap: 8px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-auto { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-record { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-clear { background: #475569; max-width: 60px; }

        .section { padding: 0 15px 10px 15px; }
        .section-title { font-size: 12px; color: #94a3b8; font-weight: 700; margin-bottom: 8px; border-left: 3px solid var(--blue); padding-left: 6px; margin-top: 10px; }
        
        .row { display: flex; gap: 8px; margin-bottom: 8px; }
        .col { flex: 1; }
        label { display: block; font-size: 10px; color: #cbd5e1; margin-bottom: 3px; }
        input { width: 100%; background: var(--input-bg); border: 1px solid #475569; color: white; padding: 10px; border-radius: 6px; font-size: 16px; font-weight: 600; text-align: center; outline: none; }
        input:focus { border-color: var(--blue); background: #1e293b; }

        /* é¡è‰²è­˜åˆ¥ */
        .hl-input input { border-color: var(--gold); background: #422006; color: #fbbf24; } 
        .trust-input input { border-color: var(--red); background: #450a0a; color: #fca5a5; } 
        .sf-input input { border-color: var(--green); background: #064e3b; color: #86efac; } 
        .total-input input { border-color: var(--purple); background: #3b0764; color: #d8b4fe; font-size: 18px; }

        .retail-group { border: 1px dashed #475569; padding: 8px; border-radius: 8px; margin-bottom: 8px; }
        .retail-label { font-size: 11px; color: #aaa; margin-bottom: 5px; text-align: center; font-weight: bold; }

        .verdict-box { background: #020617; padding: 15px; text-align: center; border-top: 1px solid #333; }
        .verdict { font-size: 24px; font-weight: 900; margin-bottom: 5px; }
        .desc { font-size: 12px; color: #94a3b8; }
        
        .history-log { max-height: 80px; overflow-y: auto; font-size: 10px; color: #666; padding: 10px; border-top: 1px solid #333; }
        #loading { display: none; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸš€ å°æŒ‡æ±ºç­–æ ¸å¿ƒ V12.0</h1>
        <div class="subtitle">å…¨è‡ªå‹•æŠ“å– â€¢ æœŸäº¤æ‰€ç›´é€£ â€¢ æ•£æˆ¶æ‹†è§£</div>
    </div>

    <div class="portal-bar">
        <a href="https://www.wantgoo.com/option/put-call-ratio" target="_blank" class="portal-btn">
            <span class="portal-icon">ğŸ”—</span> ç©è‚¡ç¶² P/C
        </a>
        <a href="https://www.wantgoo.com/futures/retail-indicator/wmt&" target="_blank" class="portal-btn">
            <span class="portal-icon">ğŸ”—</span> æ•£æˆ¶å°å°æŒ‡æ¨™
        </a>
        <a href="https://www.taifex.com.tw/cht/3/futContractsDate" target="_blank" class="portal-btn">
            <span class="portal-icon">ğŸ”—</span> æœŸäº¤æ‰€ç¢ºèª
        </a>
    </div>

    <div class="chart-container">
        <canvas id="trendChart"></canvas>
    </div>

    <div class="btn-group">
        <button class="btn btn-auto" onclick="superAutoFetch()">
            âš¡ ä¸€éµå…¨è‡ªå‹•æŠ“å– <span id="loading">â†»</span>
        </button>
        <button class="btn btn-record" onclick="recordData()">
            ğŸ’¾ è¨˜éŒ„
        </button>
        <button class="btn btn-clear" onclick="clearHistory()">ğŸ—‘ï¸</button>
    </div>

    <div class="section">
        <div class="section-title">1. åƒ¹æ ¼èˆ‡ P/C (åŸºç¤)</div>
        <div class="row">
            <div class="col hl-input">
                <label>ğŸ“ å°æŒ‡æœŸ</label>
                <input type="number" id="tx" placeholder="è‡ªå‹•æŠ“å–..." oninput="calc()">
            </div>
            <div class="col">
                <label>ğŸ›¡ï¸ P/C Ratio (%)</label>
                <input type="number" id="pc" placeholder="æ‰‹å‹•è¼¸å…¥" oninput="calc()">
            </div>
            <div class="col">
                <label>ATR æ³¢å‹•</label>
                <input type="number" id="atr" oninput="calc()">
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">2. åœŸæ´‹æˆ°æƒ… (è‡ªå‹•æŠ“å–)</div>
        <div class="row">
            <div class="col total-input">
                <label>ğŸ¦ æ³•äººç¸½å’Œ (è‡ª+æŠ•+å¤–)</label>
                <input type="number" id="total_sum" placeholder="è‡ªå‹•è¨ˆç®—" oninput="calc()">
            </div>
        </div>
        <div class="row">
            <div class="col trust-input">
                <label>ğŸ¦ æŠ•ä¿¡ (è­·ç›¤)</label>
                <input type="number" id="trust" placeholder="è‡ªå‹•æŠ“å–" oninput="calc()">
            </div>
            <div class="col sf-input">
                <label>ğŸ‘½ å¤–è³‡ (ç¸½é¡)</label>
                <input type="number" id="small_foreign" placeholder="è‡ªå‹•æŠ“å–" oninput="calc()">
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">3. æ•£æˆ¶ç²¾ç´°æ‹†è§£ (æ‰‹å‹•è¼¸å…¥)</div>
        
        <div class="retail-group">
            <div class="retail-label">â–¼ å°å°æŒ‡ (MTX)</div>
            <div class="row">
                <div class="col">
                    <label style="color:#fca5a5;">å¤šå–®å£æ•¸</label>
                    <input type="number" id="mtx_long" placeholder="ä¾‹å¦‚ 35000" style="color:#fca5a5; border-color:#991b1b;" oninput="calc()">
                </div>
                <div class="col">
                    <label style="color:#86efac;">ç©ºå–®å£æ•¸</label>
                    <input type="number" id="mtx_short" placeholder="ä¾‹å¦‚ 32000" style="color:#86efac; border-color:#065f46;" oninput="calc()">
                </div>
            </div>
        </div>

        <div class="retail-group">
            <div class="retail-label">â–¼ å¾®å°æŒ‡ (TMF)</div>
            <div class="row">
                <div class="col">
                    <label style="color:#fca5a5;">å¤šå–®å£æ•¸</label>
                    <input type="number" id="tmf_long" placeholder="å¤šå–®" style="color:#fca5a5; border-color:#991b1b;" oninput="calc()">
                </div>
                <div class="col">
                    <label style="color:#86efac;">ç©ºå–®å£æ•¸</label>
                    <input type="number" id="tmf_short" placeholder="ç©ºå–®" style="color:#86efac; border-color:#065f46;" oninput="calc()">
                </div>
            </div>
        </div>
    </div>

    <div class="verdict-box">
        <div id="verdict" class="verdict" style="color:#64748b">ç­‰å¾…æ•¸æ“š</div>
        <div id="desc" class="desc">å…¨è‡ªå‹•åˆ†æå…§è³‡è­·ç›¤èˆ‡å¤–è³‡è³£å£“</div>
        
        <div style="display:flex; justify-content:space-around; margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
            <div>
                <div style="font-size:10px; color:#888;">ä¿å®ˆç›®æ¨™</div>
                <div id="tp1" style="font-size:16px; font-weight:bold; color:#ccc;">--</div>
            </div>
            <div>
                <div style="font-size:10px; color:#888;">ç©æ¥µç›®æ¨™</div>
                <div id="tp2" style="font-size:16px; font-weight:bold; color:#ccc;">--</div>
            </div>
        </div>
    </div>
    
    <div class="history-log" id="log-display">æ­·å²ç´€éŒ„...</div>
</div>

<script>
    let myChart;
    const ids = ['tx', 'atr', 'total_sum', 'trust', 'small_foreign', 'pc', 'mtx_long', 'mtx_short', 'tmf_long', 'tmf_short'];

    window.onload = () => {
        ids.forEach(id => {
            const v = localStorage.getItem('last_' + id);
            if(v) document.getElementById(id).value = v;
        });
        initChart();
        updateChartFromStorage();
        calc();
    };

    function initChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'å°æŒ‡æœŸ', data: [], borderColor: '#3b82f6', yAxisID: 'y', borderWidth: 2, tension: 0.1 },
                    { label: 'P/C %', data: [], borderColor: '#f59e0b', yAxisID: 'y1', borderWidth: 2, borderDash: [5, 5], tension: 0.1 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { labels: { color: '#ccc', boxWidth: 10 } } },
                scales: {
                    x: { ticks: { color: '#666' }, grid: { color: '#222' } },
                    y: { type: 'linear', display: true, position: 'left', ticks: { color: '#3b82f6' }, grid: { color: '#333' } },
                    y1: { type: 'linear', display: true, position: 'right', ticks: { color: '#f59e0b' }, grid: { drawOnChartArea: false } }
                }
            }
        });
    }

    // --- è¶…ç´šå…¨è‡ªå‹•æŠ“å– (æ•´åˆç‰ˆ) ---
    async function superAutoFetch() {
        const icon = document.getElementById('loading');
        icon.style.display = 'inline-block';
        
        // 1. æŠ“å ±åƒ¹èˆ‡æ³¢å‹•
        await autoFetchPrice();
        // 2. æŠ“æœŸäº¤æ‰€æ³•äºº
        await autoFetchTaifex();
        
        icon.style.display = 'none';
        calc();
    }

    async function autoFetchPrice() {
        try {
            const ts = new Date().getTime();
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/%5ETWII?interval=1d&range=5d&_=' + ts)}`);
            const data = await res.json();
            const result = JSON.parse(data.contents).chart.result[0];
            const last = result.meta.regularMarketPrice;
            const quotes = result.indicators.quote[0];
            
            let sum = 0, count = 0;
            for(let i=0; i<quotes.high.length; i++) if(quotes.high[i]) { sum += (quotes.high[i] - quotes.low[i]); count++; }
            const atr = count ? Math.round(sum/count) : 250;

            document.getElementById('atr').value = atr;
            // å¦‚æœå°æŒ‡æœŸæ²’å¡«ï¼Œå…ˆå¡«å…¥åŠ æ¬ŠæŒ‡æ•¸ç•¶åƒè€ƒ
            if(!document.getElementById('tx').value) document.getElementById('tx').value = Math.round(last);
        } catch(e) { console.log('åƒ¹æ ¼æŠ“å–å¤±æ•—'); }
    }

    async function autoFetchTaifex() {
        // ä¾†æºå‚™æ´ï¼šä¸­æ–‡æ—¥ç›¤ â†’ è‹±æ–‡æ—¥ç›¤
        const sources = [
            'https://www.taifex.com.tw/cht/3/futContractsDateExcel',
            'https://www.taifex.com.tw/enl/eng3/futContractsDateView?menuid1=03'
        ];

        try {
            const { dealerNet, trustNet, foreignNet, reportDate } = await fetchTaifexNetOI(sources);

            document.getElementById('trust').value = Math.round(trustNet);
            // é€™è£¡å°‡å¤–è³‡ç¸½é¡å¡«å…¥ "å¤–è³‡" æ¬„ä½ (åŸå°å¤–è³‡æ¬„ä½)
            document.getElementById('small_foreign').value = Math.round(foreignNet);
            document.getElementById('total_sum').value = Math.round(dealerNet + trustNet + foreignNet);

            // æ›´æ–°æ—¥æœŸé¡¯ç¤º
            const subtitle = document.querySelector('.subtitle');
            if (subtitle && reportDate) subtitle.innerText = `å…¨è‡ªå‹•æŠ“å– â€¢ æ³•äººè³‡æ–™æ—¥ï¼š${reportDate}`;
        } catch (e) {
            alert('æœŸäº¤æ‰€æ³•äººæŠ“å–å¤±æ•—ï¼š' + (e.message || 'é€£ç·šå¤±æ•—'));
        }
    }

    // æ ¸å¿ƒçˆ¬èŸ²é‚è¼¯ (ChatGPT æä¾›)
    async function fetchTaifexNetOI(urlList) {
        let lastErr = null;
        for (const url of urlList) {
            try {
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}&_=${Date.now()}`);
                const data = await res.json();
                const html = data.contents;
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const reportDate = extractTaifexDate(doc.body.innerText);

                // æ‰¾è¡¨æ ¼
                const tables = Array.from(doc.querySelectorAll('table'));
                const table = tables.find(t => t.innerText.includes('è‡ºè‚¡æœŸè²¨')) || tables[0];
                if (!table) throw new Error('æ‰¾ä¸åˆ°è¡¨æ ¼');

                const rows = Array.from(table.querySelectorAll('tr'))
                    .map(tr => Array.from(tr.querySelectorAll('th,td')).map(td => td.innerText.trim()));

                // å®šä½è¡¨é ­
                const headerRowIdx = rows.findIndex(r => r.join(' ').includes('æœªå¹³å€‰') && r.join(' ').includes('å¤šç©ºæ·¨é¡'));
                if (headerRowIdx < 0) throw new Error('æ‰¾ä¸åˆ°è¡¨é ­');

                // å®šä½å£æ•¸æ¬„ä½ (å€’æ¨æ³•)
                const headerSlice = rows.slice(headerRowIdx, headerRowIdx + 6);
                const flat = headerSlice.map(r => r.map(x => x.replace(/\s+/g, ' ')));
                const leafIdx = flat.findIndex(r => r.filter(x => x === 'å£æ•¸').length >= 2);
                if (leafIdx < 0) throw new Error('æ‰¾ä¸åˆ°å£æ•¸æ¬„');
                
                const leafRow = rows[headerRowIdx + leafIdx];
                const qtyIndices = [];
                leafRow.forEach((cell, i) => { if (cell === 'å£æ•¸') qtyIndices.push(i); });
                if (qtyIndices.length < 6) throw new Error('å£æ•¸æ¬„æ•¸é‡ç•°å¸¸');
                const oiNetQtyIndex = qtyIndices[5]; 

                // æŠ“æ•¸æ“š
                const dataRows = rows.filter(r => r.includes('è‡ºè‚¡æœŸè²¨'));
                const dealerRow = dataRows.find(r => r.includes('è‡ªç‡Ÿå•†'));
                const trustRow  = dataRows.find(r => r.includes('æŠ•ä¿¡'));
                const foreignRow = dataRows.find(r => r.includes('å¤–è³‡'));
                
                if (!dealerRow || !trustRow || !foreignRow) throw new Error('ç¼ºå°‘æ³•äººåˆ—');

                return { 
                    dealerNet: parseIntSafe(dealerRow[oiNetQtyIndex]),
                    trustNet: parseIntSafe(trustRow[oiNetQtyIndex]),
                    foreignNet: parseIntSafe(foreignRow[oiNetQtyIndex]),
                    reportDate 
                };
            } catch (e) { lastErr = e; }
        }
        throw lastErr || new Error('å…¨éƒ¨ä¾†æºéƒ½å¤±æ•—');
    }

    function parseIntSafe(x) {
        if (x == null) return 0;
        const s = String(x).replace(/,/g, '').trim();
        const n = parseInt(s, 10);
        return Number.isFinite(n) ? n : 0;
    }

    function extractTaifexDate(text) {
        let m = text.match(/æ—¥æœŸ\s*([0-9]{4}\/[0-9]{2}\/[0-9]{2})/);
        if (m) return m[1];
        m = text.match(/([0-9]{4}\/[0-9]{2}\/[0-9]{2})/);
        return m ? m[1] : '';
    }

    function calc() {
        ids.forEach(id => {
            const el = document.getElementById(id);
            localStorage.setItem('last_' + id, el.value);
        });

        const tx = parseInt(document.getElementById('tx').value);
        const atr = parseInt(document.getElementById('atr').value) || 250;
        
        const total = parseInt(document.getElementById('total_sum').value) || 0;
        const trust = parseInt(document.getElementById('trust').value) || 0;
        const sf = parseInt(document.getElementById('small_foreign').value) || 0;
        const pc = parseFloat(document.getElementById('pc').value) || 100;
        
        const mtx_L = parseInt(document.getElementById('mtx_long').value) || 0;
        const mtx_S = parseInt(document.getElementById('mtx_short').value) || 0;
        const tmf_L = parseInt(document.getElementById('tmf_long').value) || 0;
        const tmf_S = parseInt(document.getElementById('tmf_short').value) || 0;
        
        const retail_net = (mtx_L - mtx_S) + ((tmf_L - tmf_S) * 0.2);

        if(!tx) return;

        let score = 0;
        let analysis_text = "";

        if (total > 5000) score += 30;
        else if (total < -5000) score -= 30;
        else {
            if (trust > 10000 && sf < -10000) {
                score += 10;
                analysis_text = "æŠ•ä¿¡è­·ç›¤ vs å¤–è³‡è³£å£“";
            } else if (trust < -5000 && sf > 5000) {
                score -= 10;
                analysis_text = "æŠ•ä¿¡æ£„å®ˆè½‰å¼±";
            }
        }

        if (trust > 20000) score += 15;
        if (sf < -20000) score -= 15;

        if(pc > 110) score += 20; else if(pc < 90) score -= 20;

        if(retail_net > 3000) score -= 25; 
        else if(retail_net < -3000) score += 25;

        const vEl = document.getElementById('verdict');
        const dEl = document.getElementById('desc');
        const tp1 = document.getElementById('tp1');
        const tp2 = document.getElementById('tp2');

        if(score >= 20) {
            vEl.innerText = "ğŸš€ éœ‡ç›ªåå¤š"; vEl.style.color = "#ef4444";
            dEl.innerText = analysis_text || `æ³•äººç±Œç¢¼èˆ‡P/Cæ”¯æ’å…±æŒ¯`;
            tp1.innerText = Math.round(tx + atr); tp1.style.color="#ef4444";
            tp2.innerText = Math.round(tx + atr * 1.618); tp2.style.color="#ef4444";
        } else if(score <= -20) {
            vEl.innerText = "ğŸ“‰ éœ‡ç›ªåç©º"; vEl.style.color = "#10b981";
            dEl.innerText = analysis_text || `æ³•äººèª¿ç¯€ä¸”å£“åŠ›é‡`;
            tp1.innerText = Math.round(tx - atr); tp1.style.color="#10b981";
            tp2.innerText = Math.round(tx - atr * 1.618); tp2.style.color="#10b981";
        } else {
            vEl.innerText = "âš–ï¸ å€é–“æ´—ç›¤"; vEl.style.color = "#94a3b8";
            dEl.innerText = analysis_text || `å¤šç©ºè† è‘—ï¼Œè§€æœ›ç‚ºä¸»`;
            tp1.innerText = Math.round(tx + atr * 0.5); tp1.style.color="#cbd5e1";
            tp2.innerText = Math.round(tx - atr * 0.5); tp2.style.color="#cbd5e1";
        }
    }

    function recordData() {
        const tx = document.getElementById('tx').value;
        const pc = document.getElementById('pc').value;
        if(!tx || !pc) { alert("è«‹å…ˆè¼¸å…¥æ•¸æ“š"); return; }
        const today = new Date();
        const dateStr = (today.getMonth()+1) + "/" + today.getDate();
        const newData = { date: dateStr, tx: parseFloat(tx), pc: parseFloat(pc) };
        let history = JSON.parse(localStorage.getItem('stock_history') || "[]");
        const existIdx = history.findIndex(d => d.date === dateStr);
        if(existIdx >= 0) history[existIdx] = newData;
        else history.push(newData);
        if(history.length > 14) history = history.slice(-14);
        localStorage.setItem('stock_history', JSON.stringify(history));
        updateChartFromStorage();
        alert('å·²è¨˜éŒ„ä»Šæ—¥æ•¸æ“š');
    }

    function updateChartFromStorage() {
        const history = JSON.parse(localStorage.getItem('stock_history') || "[]");
        const logEl = document.getElementById('log-display');
        myChart.data.labels = history.map(d => d.date);
        myChart.data.datasets[0].data = history.map(d => d.tx);
        myChart.data.datasets[1].data = history.map(d => d.pc);
        myChart.update();
        logEl.innerHTML = history.length ? history.map(d => `<span>[${d.date}] æŒ‡æ•¸:${d.tx} | P/C:${d.pc}%</span>`).join("<br>") : "å°šç„¡ç´€éŒ„";
    }

    function clearHistory() {
        if(confirm("æ¸…é™¤ç´€éŒ„ï¼Ÿ")) { localStorage.removeItem('stock_history'); updateChartFromStorage(); }
    }
</script>

</body>
</html>
